{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "tenantId": {
            "type": "string",
            "defaultValue": "[subscription().tenantId]"
        },
        "authorityurl": {
            "type": "string",
            "defaultValue": "https://login.microsoftonline.com"
        },
      "workspaceName": {
        "type": "string",
        "defaultValue": "rakempiws",
        "metadata": {
            "description": "Name of Health Workspace"
        }
      },
      "fhirServiceName": {
        "type": "string",
        "defaultValue": "rakempifhir",
        "metadata": {
            "description": "Name of the FHIR Service"
        }
      },
      "AccessPolicies": {
        "type": "array",
        "defaultValue": []
      },
      "smartProxyEnabled": {
        "type": "bool",
        "defaultValue": false
      },
      "Audience": {
        "type": "string",
        "defaultValue": "https://EMPIFhirResourceApp.TESTHealthArchitecturesDemo.onmicrosoft.com",
        "metadata": {
            "description": "Audience for SMART scopes in Microsoft Entra ID."
        }
      },
      "storageAccountName": {
        "type": "string",
        "defaultValue": "rakempistg",
        "metadata": {
            "description": "Name of the Storage Account"
        }
      },
      "storageAccountType": {
        "type": "string",
        "defaultValue": "Standard_LRS",
        "allowedValues": [
            "Standard_LRS",
            "Standard_GRS",
            "Standard_RAGRS"
        ],
        "metadata": {
            "description": "Storage Account type"
        }
      },
      "searchServiceName": {
        "type": "string",
        "metadata": {
            "description": "Name of AI Search Service"
        }
      }
    },
    "variables": {
        "location": "[resourceGroup().location]",
        "authority": "[Concat(parameters('authorityurl'), '/', parameters('tenantid'))]"
    },
    "resources": [
        {
            "type": "Microsoft.HealthcareApis/workspaces",
            "name": "[parameters('workspaceName')]",
            "apiVersion": "2023-02-28",
            "location": "[variables('location')]",
            "properties": {}
        },
        {
            "type": "Microsoft.HealthcareApis/workspaces/fhirservices",
            "kind": "fhir-R4",
            "name": "[concat(parameters('workspaceName'), '/', parameters('fhirServiceName'))]",
            "apiVersion": "2023-02-28",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.HealthcareApis/workspaces', parameters('workspaceName'))]"
            ],
            "properties": {
                "accessPolicies": "[parameters('AccessPolicies')]",
                "authenticationConfiguration": {
                    "authority": "[variables('authority')]",
                    "audience": "[parameters('Audience')]",
                    "smartProxyEnabled": "[parameters('smartProxyEnabled')]"
                },
                "corsConfiguration": {
                    "allowCredentials": false,
                    "headers": ["*"],
                    "maxAge": 1440,
                    "methods": ["DELETE", "GET", "OPTIONS", "PATCH", "POST", "PUT"],
                    "origins": ["*"]
                }
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[parameters('storageAccountName')]",
            "apiVersion": "2023-01-01",
            "location": "[variables('location')]",
            "sku": {
                "name": "[parameters('storageAccountType')]"
            },
            "kind": "Storage",
            "properties": {
                "supportsHttpsTrafficOnly": true,
                "defaultToOAuthAuthentication": true
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2022-09-01",
            "name": "[format('{0}/default/patientdata', parameters('storageAccountName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            ],
            "properties": {}
        },
        {
            "type": "Microsoft.Search/searchServices",
            "apiVersion": "2022-09-01",
            "name": "[parameters('searchServiceName')]",
            "location": "[variables('location')]",
            "sku": {
                "name": "standard"
            },
            "properties": {
                "replicaCount": 1,
                "partitionCount": 1
            }
        }
    ]
}